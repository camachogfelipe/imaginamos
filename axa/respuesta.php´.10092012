<?php
session_start();
include 'php/dao/daoConnection.php';
include 'php/dao/ventaDAO.php';
include 'php/entities/venta.php';
include 'php/dao/pasajeroDAO.php';
include 'php/entities/pasajero.php';
include 'php/dao/PlanDAO.php';
include 'php/entities/Plan.php';
include 'php/dao/paisDAO.php';
include 'php/entities/pais.php';
require 'php/functions/class.phpmailer.php';
require 'fpdf/fpdf.php';

$ventaDAO = new ventaDAO;
$venta = new venta;

$pasajeroDAO = new pasajeroDAO;

$planDAO = new PlanDAO;

$paisDAO = new paisDAO;
?>
<!DOCTYPE html>

<html lang="es">
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=9" />
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<title>AXA</title>

<meta name="description" content=" Encuentra los puntos Wifi ETB más cercanos y navega desde cualquier sitio. ">

<meta name="keywords" content=" wifi, zonas, etb, internet, sin cables, navega, mapa, velocidad, sitio, conectate, ciudad, navegacion, puntos, direccion" >

<link rel="icon" type="image/gif" href="images/layout/favicon.ico" />
<link rel="shortcut icon" href="images/layout/favicon.ico" />


<link href="css/style.css" rel="stylesheet" type="text/css" media="all"/>

<!--[if lt IE 9]><script src="http://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script><![endif]-->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js" type="text/javascript"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.13/jquery-ui.min.js" type="text/javascript"></script>
	<script src="js/actions-botones.js" type="text/javascript"></script>
    <script src="js/chat.js" type="text/javascript"></script>
    
    <script type="text/javascript" src="js/fancybox/jquery.mousewheel-3.0.4.pack.js"></script>
	<script type="text/javascript" src="js/fancybox/jquery.fancybox-1.3.4.pack.js"></script>
	<link rel="stylesheet" type="text/css" href="js/fancybox/jquery.fancybox-1.3.4.css" media="screen" />
   

<style type="text/css">
.error {
font-size:26px;
font-weight:bold;
color:#000;
position:absolute;
float:left;
margin-top:150px;
}


</style>
<?php include ('analytics.php');?>
</head>

<body>

<?php
$llave="137e2eab080";
$usuario_id=$_REQUEST['usuario_id'];
$ref_venta=$_REQUEST['ref_venta'];
$valor=$_REQUEST['valor'];
$moneda=$_REQUEST['moneda'];
$estado_pol=$_REQUEST['estado_pol'];
$firma_cadena= "$llave~$usuario_id~$ref_venta~$valor~$moneda~$estado_pol";$firmacreada = md5($firma_cadena);//firma que generaron ustedes
$firma =$_REQUEST['firma'];//firma que envía nuestro sistema
$ref_venta=$_REQUEST['ref_venta'];
$fecha_procesamiento=$_REQUEST['fecha_procesamiento'];
$ref_pol=$_REQUEST['ref_pol'];
$cus=$_REQUEST['cus'];
$extra1=$_REQUEST['extra1'];
$banco_pse=$_REQUEST['banco_pse'];
if($_REQUEST['estado_pol'] == 6 && $_REQUEST['codigo_respuesta_pol'] == 5)
{$estadoTx = "Transacci&oacute;n fallida";}
else if($_REQUEST['estado_pol'] == 6 && $_REQUEST['codigo_respuesta_pol'] == 4)
{$estadoTx = "Transacci&oacute;n rechazada";}
else if($_REQUEST['estado_pol'] == 12 && $_REQUEST['codigo_respuesta_pol'] == 9994)
{$estadoTx = "Pendiente, Por favor revisar si el d&eacute;bito fue realizado en el Banco";}
else if($_REQUEST['estado_pol'] == 4 && $_REQUEST['codigo_respuesta_pol'] == 1)
{
	$estadoTx = "Transacci&oacute;n aprobada";
	$venta->setPagoonlinetbl_ventas('SI');
	$venta->setReftbl_ventas($ref_venta);
	$refpol_venta = explode('_',$ref_venta);
	$ref_final = $ref_pol.$refpol_venta[1].$refpol_venta[2].$refpol_venta[3];	
	$venta->setRefTransacciontbl_ventas($ref_final);
	//echo $ref_venta.' ////';
	//echo $ref_final.' kljhlkgkhg';print_r($venta);
	//$update = true;
	$update = $ventaDAO->updatePago($venta);
	if ($update)
	{
		class PDF extends FPDF
		{
			// Cabecera de página
			/*function Header()
			{
				// Logo
				$this->Image('http://tarjetasdeasistencia-axa.com/images/layout/logo.png',10,5,50,15);
				// Arial bold 15
				$this->SetFont('Arial','B',15);
				// Movernos a la derecha
				$this->Cell(80);
				// Título
				$this->Cell(30,40,'AXA ASISTENCIA COLOMBIA CERTIFICA',0,0,'C');
				// Salto de línea
				$this->Ln(30);
			}*/
			
			// Pie de página
			function Footer()
			{
				// Posición: a 1,5 cm del final
				$this->SetY(-15);
				// Arial italic 8
				$this->SetFont('Arial','I',7);
				// Número de página
				$this->Cell(0,10,'Page '.$this->PageNo().'/{nb}',0,0,'C');
			}
			function ChapterBody($file)
			{
				// Leemos el fichero
				$txt = file_get_contents($file);
				// Times 12
				$this->SetFont('Times','',7);
				// Imprimimos el texto justificado
				$this->MultiCell(0,3,$txt);
				// Salto de línea
				$this->Ln();
				// Cita en itálica
				$this->SetFont('','I');
				$this->Cell(0,5,'(fin del extracto)');
			}
			
			function PrintChapter($num, $title, $file)
			{
				$this->AddPage();
				$this->ChapterBody($file);
			}
		}
		$listaArchivo = $ventaDAO->getbyReftrans($ref_final);
		$listaPasajeros = $pasajeroDAO->gets(0,2000);
		$nombrecsv = $ref_final.date('Ymd') .".csv";
		$csvName =  'csv/'.$nombrecsv;
		$fileHandle = fopen($csvName, 'w') or die('Can\'t create .csv file, try again later.');
		$k = 0;
		foreach ($listaArchivo as $datos)
		{
				$pajero = $pasajeroDAO->getById($datos->getTbl_pasajeros_idtbl_pasajeros());
				$nombres = $pajero->getNombretbl_pasajeros().' '.$pajero->getApellidostbl_pasajeros();
				$identificacion = $pajero->getIdenteficaciontbl_pasajeros();
				$email = $pajero->getEmailtbl_pasajeros();
				$nacimiento = $pajero->getFechanacimientotbl_pasajeros();
				$edad = $pajero->getEdad();
				$plan = $planDAO->getPlan($datos->getTbl_plan_idtbl_plan());
				$nombreplan = utf8_decode($plan->getDescripciontbl_plan());
				$pais = $paisDAO->getpais($datos->getTbl_destino_idtbl_destino());
				$nombrepais = ($pais->getDescripciontbl_destino());
				$fecha_salida = $datos->getFechasalidatbl_ventas();
				$fecha_regreso = $datos->getFecharegresotbl_ventas();
				$idplan = $datos->getTbl_plan_idtbl_plan();
				$certificacion = $datos->getRefTransacciontbl_ventas();
				if ($idplan == 1 || $idplan == 10)
				{
					$fecha_salidapdf = 'Fecha inicio plan: '.$datos->getFechasalidatbl_ventas();
					$fecha_regresopdf = 'Fecha fin plan: '.$datos->getFecharegresotbl_ventas();
				}
				else
				{
					$fecha_salidapdf = 'Fecha de salida: '.$datos->getFechasalidatbl_ventas();
					$fecha_regresopdf = 'Fecha de regreso: '.$datos->getFecharegresotbl_ventas();
				}
				if ($idplan==1)
				{
					$imgcobertura = 'America.jpg';
				}
				if ($idplan==2)
				{
					$imgcobertura = 'Plan_Multiviajes_30_Dias.jpg';
				}
				if ($idplan==3)
				{
					$imgcobertura = 'Larga_Estadia.jpg';
				}
				if ($idplan==4)
				{
					$imgcobertura = 'Clasico.jpg';
				}
				if ($idplan==5)
				{
					$imgcobertura = 'Turista_Economico.jpg';
				}
				if ($idplan==6)
				{
					$imgcobertura = 'Turista_Mundial.jpg';
				}
				if ($idplan==7)
				{
					$imgcobertura = 'Europa_y_Resto_del_Mundo.jpg';
				}
				if ($idplan==8)
				{
					$imgcobertura = 'Golden.jpg';
				}
				if ($idplan==9)
				{
					$imgcobertura = 'Estudiantil.jpg';
				}
				if ($idplan==10)
				{
					$imgcobertura = 'Plan_Multiviajes_60_Dias.jpg';
				}
				$diasviaje = $datos->getDiasviajetbl_ventas();
				$canal = $datos->getCanalventatbl_ventas();
				$fechaventa = $datos->getFechaventatbl_ventas();
				$valor = $datos->getValortbl_ventas();
				$observaciones = $datos->getObservacionestbl_ventas();
				$terminos = $datos->getTerminostbl_ventas();
				$elCSV = $nombres.",".$identificacion.",".$email.",".$nacimiento.",".$edad.",".$nombreplan.",".$nombrepais.",".$fecha_salida.",".$fecha_regreso.",".$diasviaje.",".$canal.",".$fechaventa.",".$valor.",".$observaciones.",".$terminos.",".$certificacion." \n ";
    			fwrite($fileHandle, $elCSV);
				
				#creación PDF certificado asistencia
				// Creación del objeto de la clase heredada
				$pdf = new PDF();
				$pdf->AliasNbPages();
				$pdf->AddPage();
				$pdf->Image('http://tarjetasdeasistencia-axa.com/images/pdf/'.$imgcobertura,75,60,50,40);
				$pdf->Image('http://tarjetasdeasistencia-axa.com/images/pdf/Telefono.png',40,170,120,22);
				$pdf->Image('http://tarjetasdeasistencia-axa.com/images/pdf/Firma.png',10,270,60,18);
				$pdf->Image('http://tarjetasdeasistencia-axa.com/images/layout/logo.png',10,5,50,15);
				$pdf->SetFont('Arial','B',15);
				$pdf->Cell(80);
				$pdf->Cell(30,40,'AXA ASISTENCIA COLOMBIA CERTIFICA',0,0,'C');
				$pdf->Ln(30);
				$pdf->SetFont('Times','',10);
				$pdf->MultiCell(0,5,'Que '.utf8_encode($nombres).' con identificación No. '.$identificacion.' cuenta con el servicio de asistencia médica en el exterior por adquirir la tarjeta de asistencia respaldada por Inter Partner Assistance, con el plan '.($nombreplan).' radicado bajo el número '.$ref_final.' y con las siguientes condiciones:',0,'J');
				$pdf->Cell(0,5,'',0,1);
				$pdf->Cell(0,5,'',0,1);
				$pdf->Cell(0,5,'',0,1);
				$pdf->Cell(0,5,'',0,1);
				$pdf->Cell(0,5,'',0,1);
				$pdf->Cell(0,5,'',0,1);
				$pdf->Cell(0,5,'',0,1);
				$pdf->Cell(0,5,'',0,1);
				$pdf->Cell(0,5,'',0,1);
				$pdf->Cell(0,5,'',0,1);
				
				$pdf->Cell(0,5,'La asistencia se prestará durante los primeros días de viaje a partir de la fecha de salida del país y con destino a: ',0,1);
				$pdf->Cell(0,5,($nombrepais),0,1);
				$pdf->Cell(0,5,$fecha_salidapdf,0,1);
				$pdf->Cell(0,5,$fecha_regresopdf,0,1);
				$txt = 'Las condiciones generales, límites de cobertura, excepciones y restricciones de los servicios de asistencia están a su ';
				$txt .= 'disposición en la página web www.tarjetasdeasistencia-axa.com, las cuales usted declara haber leído, atendido y aceptado. Las ';
				$txt .= 'coberturas serán aplicables durante el viaje que realice dicho Beneficiario dentro del Período-Vigencia y demás condiciones ';
				$txt .= 'establecidas para cada plan. El Beneficiario declara que al momento de la compra ha elegido el tipo de tarjeta y ha ';
				$txt .= 'aceptado los términos, condiciones y exclusiones para cada servicio de asistencia. Los servicios de asistencia serán ';
				$txt .= 'prestados de acuerdo con las definiciones y consideraciones particulares y en situación de emergencia descritos para cada ';
				$txt .= 'prestados de acuerdo con las definiciones y consideraciones particulares y en situación de emergencia descritos para cada ';
				$txt .= 'plan, por lo tanto no se configura como seguro médico, ni tiene como objeto la previsión o cuidado de salud.';
				$txt .= 'Frente a una situación de emergencia, comunicarse de inmediato con la central de alarma de Inter Partner más ';
				$txt .= 'cercana, las 24 horas del día.';
				$pdf->MultiCell(0,5,$txt,0,'J');
				
				$pdf->Cell(0,5,'',0,1);
				$pdf->Cell(0,5,'',0,1);
				$pdf->Cell(0,5,'',0,1);
				$pdf->Cell(0,5,'',0,1);
				
				$pdf->SetFont('Times','',8);
				$pdf->Cell(0,5,'* Los números telefónicos están sujetos a los cambios de codificación en cada país.',0,1); 
				$pdf->SetFont('Times','',10);
				$pdf->Cell(0,5,'Para acceder a los servicios de asistencia son requerimientos indispensables:',0,1);
				$pdf->Cell(0,5,'1. Comunicarse con la central de alarma en el momento de la emergencia.',0,1);
				$pdf->MultiCell(0,5,'2. Enviar a la central de alarma en Colombia fotocopia completa del pasaporte, donde figuren las fechas de salida y demás documentos que se soliciten.',0,'J');
				$pdf->Cell(0,5,'3. La asistencia se prestarán en el tiempo y de acuerdo con el plan adquirido.',0,1);
				$pdf->Cell(0,5,'4. El valor de la cobertura corresponde al monto equivalente de la moneda legal vigente de cada país donde',0,1);
				$pdf->Cell(0,5,'se preste el servicio de asistencia.',0,1);
				$pdf->Cell(0,5,'Este certificado se expide en Colombia el día 16 de Junio de 2012 a solicitud del interesado y de acuerdo con',0,1);
				$pdf->Cell(0,5,'el decreto 2150 de 5 de diciembre de 1995 no requiere autenticación para su validez.',0,1);
				$pdf->MultiCell(0,5,'Con el recibo de la tarjeta de asistencia el beneficiario declara haber recibido, conocido y aceptado las condiciones del contrato de asistencia.',0,'J');
				$pdf->Cell(0,5,'',0,1);
				$pdf->Cell(0,5,'',0,1);
				$pdf->Cell(0,5,'',0,1);
				$pdf->SetFont('Times','',7);
				$pdf->Cell(0,5,'Venta por cuenta de Inter Partner Assistance (IPA) - Servicios en el exterior.',0,1);
				$pdf->PrintChapter(1,'','fpdf/asistencia.txt');
				$prefijo = substr(md5(uniqid(rand())),0,6);
				$fileName = 'Asistencia_axa.pdf';
				$namefile[$k] = $prefijo."_".$fileName;
				$destinopdf[$k] = 'docpdf/'.$namefile[$k];
				$content = $pdf->Output($destinopdf[$k],'F');
				# fin creacion PDF certificado de asistencia
				$k++;
		}
		fclose($fileHandle);
		
		
		# envio de .csv a AXA
		$mail = new PHPMailer();
		$mail->AddAttachment($csvName,$nombrecsv);
		$mail->Host = "localhost";
		$mail->From = "mailto:noreply@axa-assistance.com.co";
		$mail->FromName = "AXA";
		$mail->Subject = '45086';
		$mail->AddAddress('bdclientes@axa-assistance.com.co');
		$mail->AddBCC('marketing@axa-assistance.com.co');
		$mail->Body = $body;
		$mail->IsHTML(true);
		$mail->Send();
		# FIN envio .csv a AXA
		
		# envio certificado asistencia a cliente
		$message = '<img src="http://tarjetasdeasistencia-axa.com/images/logo.jpg" title="Axa-Logo"/><br/>';
		$message .= 'Gracias por su compra. <br />Adjunto a este correo encontrara el certificado de la compra, debe imprimir y conservar este <br />certificado.<br />';
		$message .= '<p style="color:#666; font-size:8px">Copyright 2010 - Axa Assistance Colombia- Todos los Derechos Reservados</p>' ;
		$mail = new PHPMailer();
		for ($j = 0; $j<count($destinopdf);$j++)
		{
			$mail->AddAttachment($destinopdf[$j],$namefile[$j]);	
		}
		$mail->Host = "localhost";
		$mail->From = "mailto:noreply@axa-assistance.com.co";
		$mail->FromName = "AXA ASISTENCIA COLOMBIA S.A";
		$mail->Subject = 'Certificado Compra Online - AXA ASISTENCIA COLOMBIA S.A';
		$mail->AddAddress($email);
		$mail->AddBCC('marketing@axa-assistance.com.co');
		$body = "<strong>Mensaje</strong><br><br>";
		$body.= wordwrap($message, 70)."<br>";
		$mail->Body = $body;
		$mail->IsHTML(true);
		$mail->Send();
		# FIN envio certificado asistencia a cliente
		
		
	}
}
else
{$estadoTx=$_REQUEST['mensaje'];}
if(strtoupper($firma)==strtoupper($firmacreada)){//comparacion de las firmas para comprobar que los datos si vienen de Pagosonline*/
?>
<!-- Google Code for Compra Conversion Page -->
<script type="text/javascript">
/* <![CDATA[ */
var google_conversion_id = 1000339920;
var google_conversion_language = "es";
var google_conversion_format = "2";
var google_conversion_color = "ffffff";
var google_conversion_label = "9emGCNiqngMQ0PP_3AM";
var google_conversion_value = 0;
/* ]]> */
</script>
<script type="text/javascript" src="http://www.googleadservices.com/pagead/conversion.js">
</script>
<noscript>
<div style="display:inline;">
<img height="1" width="1" style="border-style:none;" alt="" src="http://www.googleadservices.com/pagead/conversion/1000339920/?value=0&amp;label=9emGCNiqngMQ0PP_3AM&amp;guid=ON&amp;script=0"/>
</div>
</noscript>

 <script>
	$(document).ready(function(){
		$.fancybox({
				'href'              : '#inline1',
				'titlePosition'		: 'inside',
				'transitionIn'		: 'none',
				'transitionOut'		: 'none',
				'showCloseButton'   : 'false',
				'modal'				: 'true'
			});
		
		})
	</script>
<header>
	<div id="logo"> <a href="index.php"><img src="images/layout/logo.png" /></a>
    </div>
    <div id="copy_home">
    	<h1>
        	<p class="copy_grande">Escoge la opción que más se acerque a tus necesidades.</p>
            <!--<p class="copy_peque">Adquiere tu tarjeta de asistencia en 3 simples pasos. ¡te tomar&aacute; menos de 5 minutos!</p>-->
        </h1>
    </div>
</header>


<section class="contenedor_contenido">

<div class="contenedr_botones_grande">

	<div class="botones_opciones">
    	<div class="contenedor_botones_opciones">
        	<div class="botones_opciones_dentro">
            	<p><a class="planes_rojos" href="index.php">Viajas a Europa de Vacaciones?</a></p>
            </div>
        </div>
    </div>
    <div class="botones_opciones">
    	<div class="contenedor_botones_opciones">
        	<div class="botones_opciones_dentro">
            	<p  style="margin-top:26px"><a class="planes_rojos" href="index2.php?idplan=8">Eres mayor de 65 años?</a></p>
            </div>
        </div>
    </div>
</div>    
    

<div class="contenedr_botones_grande">    
    
    <div class="botones_opciones">
    	<div class="contenedor_botones_opciones">
        	<div class="botones_opciones_dentro">
            	<p><a class="planes_rojos" href="index_2.php">Viajas a otra parte del Mundo?</a></p>
            </div>
        </div>
    </div>
    <div class="botones_opciones">
    	<div class="contenedor_botones_opciones">
        	<div class="botones_opciones_dentro">
            	<p><a class="planes_rojos" href="index_3.php">Viajas por más de 6 meses?</a></p>
            </div>
        </div>
    </div>
    
</div>    


<div class="contenedr_botones_grande">
    
    <div class="botones_opciones">
    	<div class="contenedor_botones_opciones">
        	<div class="botones_opciones_dentro">
            	<p>
                	<!--<a class="planes_rojos" href="index2.php?idplan=2">Vas a viajar más de 2 veces al año?</a>-->
                    <a class="planes_azules" href="#inline1" id="various1">Vas a viajar más de 2 veces al año?</a>
                    </p>
            </div>
        </div>
    </div>
    <div class="botones_opciones">
    	<div class="contenedor_botones_opciones">
        	<div class="botones_opciones_dentro">
            	<p style="color:#113182; margin-top:26px"><a class="planes_azules" href="index6.php">Ver todos los planes</a></p>
            </div>
        </div>
    </div>

</div>
   
   
</section>
<div style="display: none;">
		<div id="inline1" style="width:700px;height:700px;overflow:auto;">
			<center>
            <table width="500" border="0" cellspacing="0" cellpadding="0" >
            <tr>
            <th width="100%" scope="col"><h1>Los datos de tu transacci&oacuten son los siguientes</h1>
            <br />
            </tr>
            <td>
            
            <a href="http://www.pagosonline.com/" target="_blank"><img src="http://www.pagosonline.com/logos/images/transgrande_03_460x60.png" alt="j" width="460" height="60" border="0" /></a>
            <br />
            <table align="center"  width="%100" border="0">
            <tr>
            <td><h3>Fecha de procesamiento</h3></td>
            <td><h2><?php echo $fecha_procesamiento; ?></h2></td>
            </tr>
            <tr>
            <td><h3>Estado de la transacci&oacute;n</h3></td>
            <td><h2><?php echo $estadoTx; ?> </h2></td>
            </tr>
            <tr>
            <td><h3>referencia de la venta </h3></td>
            <td><h2><?php echo $ref_venta; ?></h2> </td> </tr>
            <tr>
            <td><h3>Referencia de la transaccion </h3></td>
            <td><h2><?php echo $ref_pol; ?> </h2></td>
            </tr>
            <tr>
            <?php
            if($banco_pse!=null){
            ?>
            <tr>
            <td><h3>cus </h3></td>
            <td><h2><?php echo $cus; ?></h2> </td>
            </tr>
            <tr>
            <td><h3>Banco</h3> </td>
            <td><h2><?php echo $banco_pse; ?></h2> </td>
            </tr>
            <?php
            }
            ?>
            <tr>
            <td><h3>Valor total</h3></td>
            <td><h2><?php echo number_format($valor); ?> </h2></td>
            </tr>
            <tr>
            <td><h3>moneda</h3> </td>
            <td><h2><?php echo $moneda; ?></h2></td>
            </tr>
            </table>
            
            
            <div align="center"><a href="#" onclick="window.print();">Imprimir</a></div><br />
            <br /> <br />
            
            <h2 align="center">Si tiene alguna duda acerca de esta transacci&oacuten por favor cumun&iacutequese con nuestro departamento de servicio al cliente.</h2>
            <div align="center">
            
            <h1 align="center">Gracias por comprar con nosotros! </h1>
            <div align="center">
            
            
            <h4><br />
            <span class="Estilo2"><a href="http://tarjetasdeasistencia-axa.com/index5.php">Ver otros productos</a></span></h4>
            </div></td>
            
            </tr>
            </table>
            </center>
            <br />
            <center>
            <h1>Gracias por su compra!</h1>
            <br />
            <p><a href="index5.php">Cerrar</a></p>
            </center>
		</div>
</div>

<?php 
include ('footer.php');
?>


<?php
}else{
?>

<h1 class="error">Error validando firma digital.</h1>

<?php
}
?>
</body>

</html>